#!/bin/bash

# do not edit below ############################################################

source /etc/wart-menu/wart.config

################################################################################

# install check
if [[ ! -d "$WARTHOG_DIR"/node ]] &>/dev/null; then

  clear
  # update system
  sudo apt update
  sudo apt install git
  sudo apt install build-essential meson ninja-build
  # git clone
  cd || exit && git clone https://github.com/warthog-network/Warthog
  # change directory
  cd Warthog
  # build
  meson build --buildtype=release
  # change directory
  cd build
  # ninja -j"minus one thread"
  ninja -j"$(echo "$(cat /proc/cpuinfo | grep -c "processor")-1" | bc 2>/dev/null)"
  # if missing
  if [[ ! -f /etc/systemd/system/wart-node.service ]] &>/dev/null; then
    # service data
    echo "[Unit]
Description=Warthog Node

[Service]
WorkingDirectory=/home/wart/Warthog/build/src/node
ExecStart=/home/wart/Warthog/build/src/node/wart-node --chain-db=/home/$USER/.warthog/chain.db3 --peers-db=/home/$USER/.warthog/peers.db3
Restart=always

[Install]
WantedBy=multi-user.target" >/tmp/wrnsrv.tmp
  fi
  # install service
  sudo mv /tmp/wrnsrv.tmp /etc/systemd/system/wart-node.service
  # reload
  sudo systemctl-reload
  # change directory
  cd src/node/
  # start node
  ./wart-node

else
  PIDOF_WART_NODE="$(pidof wart-node 2>/dev/null)"
  if [[ -z "$PIDOF_WART_NODE" ]] &>/dev/null; then
    PIDOF_WART_NODE="Offline"
  fi
  clear
  echo "Node already installed!"
  echo "PID of wart-node: $PIDOF_WART_NODE"
  sleep 2
fi

# END
