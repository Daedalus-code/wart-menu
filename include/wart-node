#!/bin/bash

# do not edit below ############################################################

source /etc/wart-menu/wart.config

################################################################################

# install check
if [[ ! -d "$WARTHOG_DIR"/node ]] &>/dev/null; then

  clear
  # update system
  sudo apt update
  sudo apt install git
  sudo apt install build-essential meson ninja-build
  # git clone
  cd || exit && git clone https://github.com/warthog-network/Warthog
  # change directory
  cd Warthog
  # build
  meson build --buildtype=release
  # change directory
  cd build || exit
  # ninja -j"minus one thread"
  ninja -j"$(echo "$(cat /proc/cpuinfo | grep -c "processor")-1" | bc 2>/dev/null)"
  # if missing
  if [[ ! -f /etc/systemd/system/wart-node.service ]] &>/dev/null; then
    # service data
    echo "[Unit]
Description=Warthog Node

[Service]
WorkingDirectory=/home/wart/Warthog/build/src/node
ExecStart=/home/wart/Warthog/build/src/node/wart-node --chain-db=/home/$USER/.warthog/chain.db3 --peers-db=/home/$USER/.warthog/peers.db3
Restart=always

[Install]
WantedBy=multi-user.target" >/tmp/wrnsrv.tmp
  fi
  # install service
  sudo mv /tmp/wrnsrv.tmp /etc/systemd/system/wart-node.service
  # reload
  sudo systemctl-reload
  # change directory
  cd src/node/ || exit
  # start node
  ./wart-node
fi

# latest release owner and repo
OWNER="warthog-network"
REPO="Warthog"
# if missing, fetch the latest release tag from gitHub api, fetch wart-node version
if [[ ! -f /tmp/ltrwr.tmp || ! -f /tmp/rnwr.tmp || ! -f /tmp/pdown.tmp ]] &>/dev/null; then
  echo "$(curl -s "https://api.github.com/repos/$OWNER/$REPO/releases/latest" | jq -r .tag_name)" >/tmp/ltrwr.tmp
  echo "$(cd "$WARTHOG_DIR"/node && ./wart-node --version | awk '{ print $2 }' | tr -d 'v')" >/tmp/rnwr.tmp
  echo "$(pidof wart-node)" >/tmp/pdown.tmp
fi

# installed and latest release
PIDOF_WART_NODE="$(cat /tmp/pdown.tmp 2>/dev/null)"
LATEST_RELEASE=$(cat /tmp/ltrwr.tmp 2>/dev/null)
INSTALLED_RELEASE="$(cat /tmp/rnwr.tmp 2</dev/null)"

# if online
if [[ -n "$PIDOF_WART_NODE" ]] &>/dev/null; then
  NODE_STATUS="Online"
else
  NODE_STATUS="Offline"
fi

################################################################################

HEIGHT="11"
WIDTH="42"
CHOICE_HEIGHT="4"
TITLE="Wart-Node"
MENU="Installed: v$INSTALLED_RELEASE Latest: v$LATEST_RELEASE
Status: $NODE_STATUS (PID: $PIDOF_WART_NODE)"

OPTIONS=(
  1 "Start            Run wart-node"
  2 "Stop             Stop node"
  3 "Update           Update node")

CHOICE=$(dialog --clear \
  --title "$TITLE" \
  --menu "$MENU" \
  $HEIGHT $WIDTH $CHOICE_HEIGHT \
  "${OPTIONS[@]}" \
  2>&1 >/dev/tty)

clear
case $CHOICE in
"1") sudo service wart-node start ;;
"2") sudo service wart-node stop ;;
"3")
  # start counting (seconds)
  START="$SECONDS"
  # change directory, ninja
  cd || exit && cd Warthog && git pull && cd build || exit && ninja -j"$(echo "$(cat /proc/cpuinfo 2>/dev/null | grep -c "processor")-1" | bc 2>/dev/null)"
  # seconds since start
  DURATION=$(echo "$SECONDS-$START" 2>&1 | bc 2>&1)
  # convert seconds
  TIMER=$(printf '%dh:%dm:%ds\n' $(("$DURATION/3600")) $(("$DURATION%3600/60")) $(("$DURATION%60")))
  echo
  read -r -p "$TIMER - Press Enter to continue" </dev/tty
  ;;
esac

# END
