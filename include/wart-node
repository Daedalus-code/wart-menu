#!/bin/bash

# do not edit below ############################################################

source /etc/wart-menu/wart.config

################################################################################

# install check
if [[ ! -d "$WARTHOG_DIR"/node ]] &>/dev/null; then

  clear
  # update system
  sudo apt update
  sudo apt install git
  sudo apt install build-essential meson ninja-build
  # git clone
  cd || exit && git clone https://github.com/warthog-network/Warthog
  # change directory
  cd Warthog
  # build
  meson build --buildtype=release
  # change directory
  cd build || exit
  # ninja -j"minus one thread"
  ninja -j"$(echo "$(cat /proc/cpuinfo | grep -c "processor")-1" | bc 2>/dev/null)"
  # if missing
  if [[ ! -f /etc/systemd/system/wart-node.service ]] &>/dev/null; then
    # service data
    echo "[Unit]
Description=Warthog Node

[Service]
WorkingDirectory=/home/wart/Warthog/build/src/node
ExecStart=/home/wart/Warthog/build/src/node/wart-node --chain-db=/home/$USER/.warthog/chain.db3 --peers-db=/home/$USER/.warthog/peers.db3
Restart=always

[Install]
WantedBy=multi-user.target" >/tmp/wrnsrv.tmp
  fi
  # install service
  sudo mv /tmp/wrnsrv.tmp /etc/systemd/system/wart-node.service
  # reload
  sudo systemctl-reload
  # change directory
  cd src/node/ || exit
  # start node
  ./wart-node
fi

################################################################################

HEIGHT="10"
WIDTH="42"
CHOICE_HEIGHT="4"
TITLE="Wart-Node"
MENU="Wart Node Options"

OPTIONS=(
  1 "Start            Run wart-node"
  2 "Stop             Stop node"
  3 "Update           Update node")

CHOICE=$(dialog --clear \
  --title "$TITLE" \
  --menu "$MENU" \
  $HEIGHT $WIDTH $CHOICE_HEIGHT \
  "${OPTIONS[@]}" \
  2>&1 >/dev/tty)

clear
case $CHOICE in
"1") sudo service wart-node start ;;
"2") sudo service wart-node stop ;;
"3")
  # display function
  display_result() {
    dialog --title "$TITLE" \
      --no-collapse \
      --tailbox "$(cd || exit && cd Warthog && git pull && cd build || exit && ninja -j"$(echo "$(cat /proc/cpuinfo 2>/dev/null | grep -c "processor")-1" | bc 2>/dev/null)")" 15 70
  }
  display_result
  ;;
esac

# END
